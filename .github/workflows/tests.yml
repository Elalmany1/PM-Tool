name: API Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r api_requirements.txt
        pip install pytest pytest-asyncio httpx
    
    - name: Run API health check
      run: |
        python -c "
        import sys
        try:
            from kpi_api import app
            from fastapi.testclient import TestClient
            client = TestClient(app)
            response = client.get('/health')
            assert response.status_code == 200
            print('✅ Health check passed')
            
            # Test a metric endpoint
            response = client.post('/metrics/arpu', json={
                'total_revenue': 50000,
                'total_users': 1000,
                'time_frame': 'monthly'
            })
            assert response.status_code == 200
            result = response.json()
            assert 'value' in result
            assert result['value'] == 50.0
            print('✅ ARPU calculation passed')
            
            print('✅ All checks passed')
        except Exception as e:
            print(f'❌ Error: {e}')
            sys.exit(1)
        "

    - name: Lint with Pylint
      run: |
        pip install pylint
        pylint kpi_api.py --exit-zero --disable=line-too-long,missing-docstring || true
